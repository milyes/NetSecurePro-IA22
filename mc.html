<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NetSecurePro NetworkGuard — Interface</title>
  <style>
    :root{
      --bg:#0f1720; --card:#0b1220; --muted:#9ad; --accent:#06b6d4; --text:#e6eef8;
      --ok:#10b981; --warn:#f59e0b;
      font-synthesis: none;
    }
    html,body{height:100%;margin:0;background:#0b0f14;font-family:Inter,Helvetica,Arial,sans-serif;color:var(--text)}
    .wrap{max-width:1100px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:14px}
    h1{font-size:1.25rem;margin:0}
    .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
    button{background:var(--accent);border:none;color:#012;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .meta{color:var(--muted);font-size:0.9rem}
    .toolbar{display:flex;gap:8px;align-items:center;margin:12px 0}
    input[type="search"]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);min-width:220px}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:0.95rem}
    thead th{font-size:0.85rem;opacity:0.9;text-align:left;padding:10px;border-bottom:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    tbody td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .small{font-size:0.85rem;color:var(--muted)}
    .tag{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:600;color:var(--muted);display:inline-block}
    footer{margin-top:18px;color:var(--muted);font-size:0.85rem}
    .status-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;vertical-align:middle}
    .no-data{padding:22px;text-align:center;color:var(--muted)}
    @media (max-width:700px){
      header{flex-direction:column;align-items:flex-start;gap:8px}
      .controls{margin-left:0;width:100%;justify-content:space-between}
      input[type="search"]{flex:1}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>NetSecurePro NetworkGuard</h1>
        <div class="meta">Monitoring local — réseau domestique</div>
      </div>

      <div class="controls">
        <div class="meta" id="lastScan">Dernier scan : —</div>
        <button id="scanBtn">Lancer un scan</button>
        <button id="exportBtn" class="ghost">Exporter CSV</button>
      </div>
    </header>

    <section class="card">
      <div class="toolbar">
        <input id="searchInput" type="search" placeholder="Rechercher IP, MAC, vendor, hostname..." />
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <span class="small">Total :</span>
          <span id="totalCount" class="tag">0</span>
        </div>
      </div>

      <div id="tableWrap">
        <table id="devicesTable" aria-live="polite">
          <thead>
            <tr>
              <th>IP</th>
              <th>MAC</th>
              <th>Vendor</th>
              <th>Hostname</th>
              <th>1ère vue</th>
              <th>Dernière vue</th>
            </tr>
          </thead>
          <tbody id="devicesTbody">
            <tr><td colspan="6" class="no-data">Chargement…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <footer>
      <div>Serveur local attendu : <code>/api/devices</code> &nbsp; • &nbsp; Pour API scan : <code>POST /api/scan</code></div>
    </footer>
  </div>

<script>
/*
  NetSecurePro NetworkGuard — UI
  - Récupère /api/devices (GET)
  - Lance scan via /api/scan (POST)
  - Recherche et export CSV
  - Polling automatique
*/

const API_DEV = '/api/devices';
const API_SCAN = '/api/scan';
const POLL_INTERVAL = 15000; // ms

let devicesCache = [];

// utilities
function fmtDate(s){
  if(!s) return '';
  try { const d=new Date(s); return d.toLocaleString(); } catch(e){ return s; }
}
function escapeCsvCell(v){ if(v===null||v===undefined) return ''; return '"'+String(v).replace(/"/g,'""')+'"'; }

// fetch devices and render
async function loadDevices(showLoading=true){
  try{
    if(showLoading){
      document.getElementById('devicesTbody').innerHTML = '<tr><td colspan="6" class="no-data">Chargement…</td></tr>';
    }
    const res = await fetch(API_DEV,{cache:'no-store'});
    if(!res.ok) throw new Error('Erreur API');
    const data = await res.json();
    devicesCache = Array.isArray(data) ? data : [];
    renderTable(devicesCache);
    const now = new Date();
    document.getElementById('lastScan').textContent = 'Dernier scan : ' + now.toLocaleString();
    document.getElementById('totalCount').textContent = devicesCache.length;
  } catch(err){
    document.getElementById('devicesTbody').innerHTML = '<tr><td colspan="6" class="no-data">Imposible de joindre le serveur — vérifie server.py</td></tr>';
    console.error(err);
  }
}

function renderTable(items){
  const tbody = document.getElementById('devicesTbody');
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const filtered = items.filter(d => {
    if(!q) return true;
    return (d.ip||'').toLowerCase().includes(q) ||
           (d.mac||'').toLowerCase().includes(q) ||
           (d.vendor||'').toLowerCase().includes(q) ||
           (d.hostname||'').toLowerCase().includes(q);
  });
  if(filtered.length===0){
    tbody.innerHTML = '<tr><td colspan="6" class="no-data">Aucun appareil détecté</td></tr>';
    document.getElementById('totalCount').textContent = 0;
    return;
  }
  document.getElementById('totalCount').textContent = filtered.length;
  tbody.innerHTML = '';
  filtered.forEach(d=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${d.ip||''}</strong></td>
      <td class="small">${d.mac||''}</td>
      <td class="small">${d.vendor||''}</td>
      <td class="small">${d.hostname||''}</td>
      <td class="small">${fmtDate(d.first_seen)}</td>
      <td class="small">${fmtDate(d.last_seen)}</td>
    `;
    tbody.appendChild(tr);
  });
}

// trigger scan via API
async function triggerScan(){
  try{
    document.getElementById('scanBtn').textContent = 'Scan en cours…';
    document.getElementById('scanBtn').disabled = true;
    const res = await fetch(API_SCAN, {method:'POST'});
    if(!res.ok) throw new Error('Scan failed');
    // give server time to run first incremental update
    setTimeout(()=>{ loadDevices(); }, 2200);
  } catch(err){
    alert('Erreur lors du lancement du scan : ' + err.message);
  } finally {
    setTimeout(()=>{ document.getElementById('scanBtn').disabled=false; document.getElementById('scanBtn').textContent='Lancer un scan'; }, 2500);
  }
}

// export CSV
function exportCSV(){
  if(!devicesCache || devicesCache.length===0){ alert('Aucun device à exporter'); return; }
  const header = ['ip','mac','vendor','hostname','first_seen','last_seen'];
  const rows = devicesCache.map(d => header.map(h => escapeCsvCell(d[h]||'')).join(','));
  const csv = header.join(',') + '\n' + rows.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'netsecurepro_devices.csv'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

// events
document.getElementById('scanBtn').addEventListener('click', triggerScan);
document.getElementById('searchInput').addEventListener('input', ()=> renderTable(devicesCache));
document.getElementById('exportBtn').addEventListener('click', exportCSV);

// initial load + polling
loadDevices(false);
setInterval(loadDevices, POLL_INTERVAL);
</script>
</body>
</html>
